---
author: [Even]
date: [2025年10月20日]
update: [2025年10月20日]
title: [【计算机网络】4 网络层：数据平面]
tags: [计算机网络, 网络层, 数据平面]
---

# 4 网络层：数据平面

## 4.1 导论

- 传统方法：基于目标地址匹配路由表，对分组作转发
- 流表：由集中式网络操作系统计算出来通过南向接口交给分组交换设备
- SDN(Software-Defined Networking)
    - 基于多个字段+流表
        - 源MAC-目标MAC
        - 源IP-目标IP
        - 源端口-目标端口
        - 源标志位-目标标志位
    - 流表匹配
    - 操作(Action)
        - 转发
        - 阻止(Block)
        - 泛洪(Flood)
        - 修改某些字段
- 转发：数据平面功能
- 路由：控制平面功能
- SDN是逻辑集中的控制平面，可远程操作
- 远程控制器与本地控制代理(CAs)交互
- 网络**服务模型**
    - 对单个数据报
        - 可靠传送
        - 延迟保证，如小于40ms延迟
    - 对数据报流
        - 是否保序的数据报传送
        - 保证流的最小带宽
        - 分组之间的延迟差

| 网络架构 | 服务模型 | 带宽 | 丢失 | 保序 | 延迟 | 拥塞反馈 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **传统互联网 (IP)** | 尽力而为 (Best-Effort) | 不保证。共享链路，带宽随网络负载动态变化。 | 不保证。数据包可能因队列溢出等原因丢失。 | 不保证。分组可能通过不同路径或因重传而乱序到达。 | 不保证。延迟和抖动（延迟变化）可能很大且不可预测。 | 无显式反馈。依赖上层协议（如TCP）通过超时和丢包推断拥塞。 |
| **ATM (异步传输模式)** | 面向连接的虚电路 (Virtual Circuit) | 保证。建立连接时根据服务类别（如CBR, VBR）协商并保证带宽。 | 低且有界。网络承诺在约定参数内极低的丢失率。 | 保证。属于同一虚电路的信元按序交付。 | 保证。根据服务类别（如CBR, rt-VBR）提供有界的延迟和低抖动。 | 有显式反馈。使用信令（如RM信元）进行拥塞控制，可通知发送方降低速率。 |
| **MPLS (多协议标签交换)** | 基于标签的转发 (Label-Switched Path) | 可保证。可通过流量工程和约束路由预留带宽，提供服务等级协议（SLA）。 | 可控。通过优先级队列和资源预留，可将关键流量的丢失率降至最低。 | 保证。属于同一LSP（标签交换路径）的数据包按序转发。 | 可管理。结合DiffServ可提供低延迟、低抖动的转发，支持流量工程优化路径。 | 间接反馈。本身不直接提供，但常与DiffServ或RSVP-TE结合，通过协议机制响应拥塞。 |
| **区分服务 (DiffServ)** | 分类与优先级标记 (Class-based) | 不保证绝对带宽。提供相对优先级，高优先级流量在拥塞时获得更多带宽。 | 不保证。但高优先级流量（如EF）的丢失率远低于尽力而为流量。 | 不保证。即使在同一服务等级内，也可能因并行路径而乱序。 | 不保证绝对延迟。但高优先级流量（如EF）享有最低延迟和抖动。 | 无直接反馈。依赖上层协议。核心网络根据DSCP标记进行优先级调度，隐式体现拥塞处理。 |
| **集成服务 (IntServ)** | 资源预留 (Resource Reservation) | 保证。通过RSVP协议为单个流预留所需带宽。 | 保证。在预留资源内，承诺极低的丢失率。 | 保证。属于同一预留流的数据包按序交付。 | 保证。承诺满足应用要求的有界延迟和抖动。 | 有显式反馈。接纳控制拒绝超出网络能力的请求，RSVP提供端到端的资源状态信息。 |

## 4.2 路由器组成
- 路由器简单结构概况
    - 路由：运行路由选择算法/协议(RIP,OSPF,BGP)生成路由表
    - 转发：从输入到输出链路交换数据报-根据路由表进行分组转发
- 输入端口功能
    - 物理层：Bit级别接收
    - 数据链路层：链路层协议动作、解封装（如Ethercat）
    - 分布式交换：
        - 根据数据报头部信息在输入端口内存的转发表中寻找合适的输出端口
        - 基于目标的转发：仅依赖于IP数据报的目标IP地址（传统方法）
        - 通用转发：基于头部字段的任意集合进行转发（SDN等）
    - 输入端口缓存
        - 交换机构速率小于输入端口汇聚速率->输入端口可能要排队（排队延迟/缓存溢出会导致丢失）
        - Head-of-the-Line(HOL) blocking：排在队头的数据报阻止了队列中其他数据报前移
- 交换结构
    - memory(内存型)
        - 第一代路由器
        - CPU直接控制下的交换
        - 转发速率被内存带宽限制
        - 一次只能转发一个分组
        - 经过两次bus
    - bus(总线型)
        - 端口总线
        - 总线竞争：交换速度受限于总线带宽
        - 1次处理1个分组
        - 速率可达Gbps
    - crossbar(交换矩阵型)
        - 并发转发多个分组，克服总线带宽限制
        - 多个处理器互联
        - 逻辑上短接映射（类似FPGA查找表）
        - 高级设计：数据报分片为固定长度信元，通过交换网络交换
        - 榕树(banyan)/crossbar
        - 速率达到60Gbps+(骨干网络)
- 调度机制
    - 调度：选择下一个要通过链路传输的分组
    - FIFO：按分组到来的次序发送
    - 丢弃策略：队列已满，哪个分组会被丢弃？
        - tail drop:丢弃刚到达的分组
        - priority:根据优先权丢弃/移除分组
        - random:随机地丢弃/移除
    - 优先权调度
    - Round Rubin轮转
    - Weited Fair Queuing(WFQ)加权公平队列
    - ...总之并不一定先进先出，即使使用的是FIFO

## 4.3 IP Inernet Protocol
``` mermaid
---
title: "IPv4 Datagram Format"
---
packet
0-3: "Version (4 bits)"
4-7: "IHL (4 bits)"
8-15: "Type of Service (ToS) / DSCP + ECN (8 bits)"
16-31: "Total Length (16 bits)"
32-47: "Identification (16 bits)"
48-49: "Flags (3 bits)"
50-63: "Fragment Offset (13 bits)"
64-71: "Time to Live (TTL, 8 bits)"
72-79: "Protocol (8 bits)"
80-95: "Header Checksum (16 bits)"
96-127: "Source IP Address (32 bits)"
128-159: "Destination IP Address (32 bits)"
160-191: "Options (if any, variable length)"
192-223: "Data (Payload, variable length)"
```

- IP编址
    - IP地址(32 Bits)
        - 路由器一定有两个甚至以上的IP地址
    - 接口：物理连接
        - 路由器通常有多个接口
        - 主机也可能有多个接口
        - IP地址和每一个接口关联
    - 一个IP地址和一个接口相关联
- 子网
    - IP地址前缀相同（将前缀称为子网号）
    - 收发不需要路由器（通过交换机1跳可达）
- IP地址分类
    - A类 IP数$2^7 - 2=126$个 主机数$2^{24} - 2=16777214$个（去除全0和全1）
    - B类 IP数$2^{14} - 2=16382$个 主机数$2^{16}-2=65534$个 (10开头)
    - C类 IP数$2^{21} - 2=2097150$个 主机数 $2^8 - 2=254$个 (110开头)
    - D类 Multicast (1110开头)
    - E类 Reversed for the future (11110开头)
- A~C为单播地址 D类为组播地址
- 特殊IP地址
    - 子网部分全0--本网络
    - 主机部分全0--本主机
    - 主机部分全1--广播地址，这个网络的所有主机
    - 网络号特定，主机号全1--来自远程网络的广播
    - 127开头，主机号任意--本地回环
    - 内网专用IP地址：永远不会被当做公用IP地址使用，仅用于区分内网设备，路由器不转发这些IP的分组
        - A类 10.0.0.0~10.255.255.255 MASK 255.0.0.0
        - B类 172.16.0.0~172.31.255.255 MASK 255.255.0.0
        - C类 192.168.0.0~192.168.255.255 MASK 255.255.255.0
- CIDR(Classless InterDomain Routing)无类域间路由
    - 子网部分的划分可在任意位置
    - 地址格式a.b.c.d/x，其中x为地址中子网号的长度
    - 子网掩码也随之变化，可划分在任意位置
- 转发表和转发算法
    - 获得IP数据报的目标地址
    - 对转发表的每个表项
        - If (IP Des Addr & Mask)==destination，则按表项对应接口转发数据报
        - 如果都没找到，则使用默认表项转发数据报

|Destination Subnet Num|Mask|Next hop|Interface|
|:---|:---|:---|:---|
|202.38.73.0|255.255.255.192|IPx|Lan1|
|202.38.64.0|255.255.255.192|IPy|Lan2|
|...|...|...|...|
|default|-|IPz|Lan0|

- 主机获取IP地址的方法
    - 静态IP：配置在一个文件中
        - Wintel:control-panel->network->configuation->tcp/ip->properties
        - Unix:/etc/rc.config
    - 动态IP：DHCP(Dynamic Host Configuration Protocol)由DHCP Sever分配（1h租用更新一次）
- ISP获得地址块的方法
    - ICANN(Internet Coporation for Assigned Names and Numbers)
    - 分配地址
    - 管理域名DNS
    - 分配域名，防止冲突
- 层次编址：路由聚集/路由聚合（route aggregation）
    - 减少路由表项数量、路由表规模、路由信息通告代价
    - 多个IP的路由信息集合成一块发送
    - 允许有空洞的聚集
- NAT(Network Address Translation)
    - 动机
        - 本地网络只有一个有效IP地址
        - 不需要从ISP分配一块地址，只需一个地址即可（省钱）
        - 局域网设备改变，不需要通知外界
        - 可以改变ISP而不需要改变内部设备地址
        - 局域网内部设备没有明确IP，
- NAT穿越问题
    - 1. 静态配置NAT，转发进来的对服务器特定端口连接请求
    - 2. UPnP(Universal Plug and Play Internet Gateway Device)协议
        - 允许NATed主机可以获知网络的公共IP地址
        - 列举存在的端口映射
        - 增/删端口映射（在租用时间内）
    - 3. 中继
        - 内网设备主动与第三方连接，形成中继建立桥接
- IPv6
    - 128 Bits
    - 头部格式改变辅助QoS
    - 路由器不做分片，ICMPv6通知源主机分片
    - flow流标签
   
``` mermaid
---
title IPv6 Datagram Format
---
packet
0-3: "Version (4 bits)"
4-11: "Traffic Class (8 bits)"
12-31: "Flow Label (20 bits)"
32-47: "Payload Length (16 bits)"
48-55: "Next Header (8 bits)"
56-63: "Hop Limit (8 bits)"
64-191: "Source Address (128 bits)"
192-319: "Destination Address (128 bits)"
320-351: "Data (Payload, variable length)"
```

- IPv4/IPv6
    - 混合隧道转发
    - 一开始使用IPv4隧道
    - 之后使用IPv6隧道
    - 平滑过渡

## 4.4 通用转发和SDN

- 传统方法：控制平面和数据平面集成
- SDN(Software Defining Network)
    - 基于流(Stream)的匹配+行动(Action)
    - 控制平面和数据平面分离
    - 控制平面功能在数据交换设备之外实现
    - 网络可编程
- SDN架构
    - 数据平面交换机
        - 南向接口
    - SDN控制器
        - 北向接口