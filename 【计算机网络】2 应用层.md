---
author: [Even]
date: [2025年09月23日]
update: [2025年09月23日]
title: [【计算机网络】2 应用层]
tags: [计网,TCP/IP,Web,HTTP,FTP,Email,DNS,P2P,CDN,TCP Socket,UDP Socket]
---

# 2 应用层
## 2.1 应用层原理

## 2.2 Web and HTTP
- HTTP请求header与body，POST与GET方法，带参数请求
- `http://url?param1&param2`
- 二八假设：互联网上80%的流量访问20%的热点资源
- 带宽不足的情况下，为避免流量强度接近1导致排队延迟指数增长$t_{queue}=\dfrac{I}{1-I}\dfrac{L}{R}$，可以通过客户端局域网内部署缓存节点降低ISP带宽占用，ISP带宽仅用于访问非热点资源，可降低流量强度
- 在客户端增加cookie使无状态连接转换为有状态连接，但cookie并不是提供数据缓存功能，不存储网页资源

## 2.3 FTP
- FTP数据连接与控制命令连接分离
- FTP的常用端口为21端口，21端口建立的连接用于传输控制命令
- 连接建立后，服务器端主动与客户端20端口建立连接，用于传输数据命令
- 服务器端需要维护客户端状态，因此为有状态的TCP连接

## 2.4 Email
- 用户代理发送邮件至邮件服务器（客户）
- 邮件服务器通过SMTP传输邮件至邮件服务器（服务器）
- 用户代理用 POP3(Post Office Protocol 3) IMAP HTTP 从邮件服务器拉取邮件
- SMTP规定所有报文必须为可打印的ASCII码，即0~127
- SMTP为持久连接
- 可使用telnet连接到25端口发送命令模拟SMTP交互
- 为使用中文等其他字符，使用MIME(Multimedia Mail Extension)在报文首部用额外的行声明MIME内容类型，声明了编码方式等
- POP3 IMAP为有状态协议，需维护客户端状态

## 2.5 DNS
- 名字空间，域为逻辑划分，可以从树的角度分析
- 创建一个新的域，必须征得它所属域的同意
- 名字服务器的问题
    - 可靠性问题：单点故障
    - 扩展性问题：通信容量
    - 维护问题：远距离的集中式数据库
- 权威 (Authorized) 服务器
- TLD(Top Layer Domain) Server
- 资源记录维护域名、TTL(Time to live)生存时间：短->缓冲记录、长->权威记录、Type：邮件名字服务器/Web服务器
- 设备上网，需要自身IP、子网掩码、GATEWAY、Local Name Solver(Default Name Solver)：自动配置DHCP/手动配置
- Local Name Solver 有缓存直接返回
    - 无缓存溯源询问根服务器-->递归查询
    - 逐级询问：迭代查询
- 缓冲为了性能，删除为了一致性
- DNS报文中ID号结果查询，是流水线(Pipeline)查询基础

## 2.6 P2P
- P2P模式是针对C/S架构的瓶颈问题而提出的新架构
- 文件分发时间：P2P模式
  - 服务器传输：最少需要上传一份拷贝
    - 发送一个拷贝的时间$\dfrac{F}{u_s}$
  - 客户端：每个客户端必须下载一个拷贝
    - 最小下载带宽$d_{min}$，客户单耗时$\dfrac{F}{d_{min}}$
  - 客户端：所有客户端总体下载量NF
    - 最大上载带宽：$u_s+\Sigma u_i$
    - 除了服务器可上载，其他所有peer节点均可上载
- 采用P2P方法将一个大小为F的文件分发给N个客户端耗时
$$D_{P2P} \geq max\{\dfrac{F}{u_s},\dfrac{F}{d_{min}},\dfrac{NF}{u_s+\Sigma u_i} \} $$
- 可管理性较差，具有高度动态性
- 非结构化P2P
  - 集中化目录：内容分散，目录集中
    - 单点故障
    - 性能瓶颈
    - 侵犯版权
  - 查询泛洪：Gnutella->完全分布式
    - 全分布式
    - 开放文件共享协议
    - 通过TCP报文，向所有邻居查询，命中后反向查询
    - 限制泛洪范围、跳数，防止回荡
    - 建立死党列表，发出ping后随机选取数个响应pong的节点构建overlay，节点离开后，再增加节点维持度的数量
  - 混合体
    - 组长跟踪所有小组内节点
- DHTC(分布式哈希表)结构化P2P
  - 上载时计算唯一哈希值，用户查询时匹配描述，然后查询对应哈希值
  - 节点按IP地址、哈希构成唯一ID值，排序形成环状拓扑
  - 约定好哈希对应节点ID，方便快速查询文件所在位置
  - 无中心Tracker
- BitTorrent
  - 整块数据分为多个256KB数据块存储
  - 节点维护自己的bitmap，每个bit表示对应数据块是否存在
  - 稀缺优先，空节点上线先随机获取四个块，再寻找最稀缺的块优先下载
  - 优先对服务质量好的节点提供服务
  - BitTorrent Tracker为中心式的服务节点管理服务器，处理客户端与服务节点连接

## 2.7 CDN
- 视频流化服务和CDN：上下文
- 分布式应用层异构客户端
- 视频压缩后传输
- CBR(Constant Bit Rate)/VBR(Variable Bit Rate)
- 多媒体流化服务：DASH(Dynamic Adaptive Streaming over HTTP)
- Manifest文件管理视频数据块，存储码率、清晰度等属性，客户端动态决定
- CDN(Content Distribution Network)内容分发网络在全网部署缓存节点
    - 流媒体点播加速/直播加速
    - 节点部署在local ISP
    - 节点部署在关键ISP
    - 网络拥塞后可以另寻路径
    - CDN运营在应用层
- OTT挑战
    - 从哪个CDN取得内容
    - 在哪些CDN存储哪些内容
    - 用户在网络拥塞时的行为
- CDN内容分发过程解析，关键步骤重定向

## 2.8 TCP Socket编程
- 服务器
    - 创建Socket返回整数，隐式绑定本地IP本地端口
    - 捆绑
    - 等待
- 客户端
    - 创建本地Socket，隐式绑定本地IP本地端口
    - 解除阻塞
    - 建立连接
- 数据结构sockaddr_in
    ``` c
    struct sockaddr_in{
        short sin_famliy;//AF_INET
        u_short sin_port;//port
        struct in_addr sin_addr;//IP addr
        char sin_zero[8];
    }
    ```
- 数据结构host_ent
    ``` c
    struct hostent{
        char *h_name;//host name
        char **h_aliased;//host aliases
        int h_addrtype;//
        int h_length;//addr length
        char **h_addr_list;//addr list
        #define h_addr h_addr_list[0];
    }
    ```
- 两个进程可以使用同一端口号，但是是不同的Socket
- Connection Socket连接完成，Welcome Socket可被重用

## 2.9 UDP Socket
- 没有握手
- 本地IP本地UDP端口
- 报文中指明目标IP目标端口
- 服务器从packet中提取IP及port
- UDP无连接

## 2.10 小结
- 应用程序体系结构
    - C/S
    - P2P
    - 混合
- 应用程序需要的服务品质描述
    - 可靠性
    - 带宽
    - 延时
    - 安全
- Internet传输层服务模式
    - 可靠的、面向连接的服务：TCP
    - 不可靠的数据报：UDP
- 流行的应用层协议
    - HTTP
    - FTP
    - SMTP,POP,IMAP
    - DNS
- Socket编程
- 应用层协议知识
    - 报文类型：请求/响应报文
    - 报文格式：首部/数据
    - 控制报文/数据报文：带内/带外
    - 集中式/分散式
    - 无状态/有状态
    - 可靠/不可靠的报文传输
    - 在网络边缘处理复杂性

