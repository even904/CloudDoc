---
author: [Even]
date: [2025年10月20日]
update: [2025年10月20日]
title: [【计算机网络】实践-1：局域网转发]
tags: [计算机网络, 代理, 端口转发]
---
# 实践-1：局域网转发

## 1 在wsl内部实现端口转发

这是一个简单的sh脚本，用于实现wsl内部代理设置。

``` sh
#!/bin/sh
hostip=$(ip route | grep default | awk '{print $3}')
wslip=$(hostname -I | awk '{print $1}')
port=7890

PROXY_HTTP="http://${hostip}:${port}"

set_proxy(){
    export http_proxy="${PROXY_HTTP}"
    export HTTP_PROXY="${PROXY_HTTP}"

    export https_proxy="${PROXY_HTTP}"
    export HTTPS_proxy="${PROXY_HTTP}"
}

unset_proxy(){
    unset http_proxy
    unset HTTP_PROXY
    unset https_proxy
    unset HTTPS_PROXY
}

test_setting(){
    echo "Host ip:" ${hostip}
    echo "WSL ip:" ${wslip}
    echo "Current proxy:" $https_proxy
}

if [ "$1" = "set" ]
then
    set_proxy

elif [ "$1" = "unset" ]
then
    unset_proxy

elif [ "$1" = "test" ]
then
    test_setting
else
    echo "Unsupported arguments."
fi
```
调用`source ./proxy.sh set`即可设置wsl内部代理，并更新环境变量。

wsl默认运行的网络模式为NAT模式，通过虚拟网卡与宿主机共享网络。要使用宿主机的端口作为wsl的出入流量端口，首先需要知道宿主机的IP地址。
wsl每次启动时，所建立的虚拟NAT局域网的网关IP地址都是不一样的；并且，宿主机的IP地址也由DHCP分配，每次启动不相同。
查看windows的虚拟NAT局域网IP地址如下。
``` ps1
以太网适配器 vEthernet (WSL (Hyper-V firewall)):

   连接特定的 DNS 后缀 . . . . . . . :
   本地链接 IPv6 地址. . . . . . . . : fe80::e58c:d54e:7c7b:32b3%50
   IPv4 地址 . . . . . . . . . . . . : 172.28.240.1
   子网掩码  . . . . . . . . . . . . : 255.255.240.0
   默认网关. . . . . . . . . . . . . :
```
为了使用宿主机端口，需要在wsl内获取宿主机IP。使用`ip route`显示系统的路由表：
``` sh 
[0.000s] > ~$ ip route
default via 172.28.240.1 dev eth0 proto kernel
172.28.240.0/20 dev eth0 proto kernel scope link src 172.28.247.254
```
提取对应行，也就是第一行中的wsl网关信息，使用文本处理工具`awk`提取第3个字段，即可取出wsl网关ip，也就是宿主机ip地址。wsl进出流量都经过这个ip转发。
``` sh
[0.002s] > ~$ ip route | grep default | awk '{print $3}'
172.28.240.1
```
于是我们在wsl内得到了宿主机虚拟网卡的ip地址。
当使用宿主机的端口（如7890）作转发时，需要注意以下几点：
- 保证端口被监听，可使用`netstat -ano | findstr :7890`在powershell内查看端口监听情况，确保其被正确的内核程序监听
    ```
    > netstat -ano | findstr :7890
    TCP    0.0.0.0:7890           0.0.0.0:0              LISTENING       25192
    ...
    ```
- 可记录PID（此处为:`25192`）并通过`tasklist | findstr 25192`查看监听（占用此端口）的程序
- 若仅监听本地回环`127.0.0.1:7890`，则无法保证来自wsl的流量可被转发
- 设置防火墙出入站流量规则或关闭防火墙，防止wsl流量被屏蔽
- `https_proxy`也是`http://${hostip}:${port}`，因为协议前缀是与代理通信时使用的协议，而不是与目标网站的协议，通常不需要SSL认证

## 2 远程服务器通过ssh实现反向代理

通过`ssh -D`，可以在本地创建一个SOCKS5代理隧道，所有通过该隧道的流量可被转发到本地电脑，并由本地电脑发出。

1. 建立ssh反向socks代理
本地启动一个SOCKS5代理服务，监听`127.0.0.1:1080`
``` sh
ssh -D 1080 user@remote-server-ip
```
- 所有通过这个SOCKS5代理的请求，都会通过ssh发送到本地系统，然后由本地系统发出
2. 远程服务器上使用这个代理
``` sh
ssh -D 1080 -R 1080:localhost:1080 user@remote-server-ip
```
`-R 1080:localhost:1080`参数将远程端口`1080`流量转发到本地系统的`1080`端口。

注意，若使用`-R 0.0.0.0:1080`则可允许公网访问。
3. 远程服务器上配置代理
``` sh
export http_proxy=socks5://127.0.0.1:1080
export https_proxy=socks5://127.0.0.1:1080
```
设置远程服务器的代理为上述ssh在本地系统上开启的端口。

远程流量将通过socks5经过ssh隧道复用反向转发至本地端口`1080`，又因本地系统代理设置，于是可通过本地代理端口转发http/https请求。

测试：远程服务器上运行，预期输出如下
``` sh
curl --socks5 127.0.0.1:1080 -v https://httpbin.org/ip
...
{
  "origin": "222.244.139.182"
}
```
